name: Build VkGHL Vulkan Layer

on:
  workflow_dispatch:

jobs:
  build-vkghl:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          repository: pchome/VkGHL

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # Removido 'vulkan-headers' pois libvulkan-dev já faz o trabalho
          sudo apt-get install -y \
            cmake build-essential \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libvulkan-dev

      - name: Build for ARM64
        run: |
          mkdir -p build
          cd build
          
          # Configura o CMake para compilar para ARM64
          cmake .. \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_BUILD_TYPE=Release
          
          make

      - name: Prepare Artifacts
        run: |
          mkdir -p output/
          # No VkGHL, o nome da lib gerada pode variar, usamos curinga *.so para garantir
          cp build/*.so output/libVkLayer_VkGHL.so
          
          # O arquivo JSON original precisa ser copiado também
          cp VkLayer_VkGHL.json output/

      - uses: actions/upload-artifact@v4
        with:
          name: vkghl-arm64
          path: output/
