name: Build VkGHL (Fix Headers)

on:
  workflow_dispatch:

jobs:
  build-vkghl:
    runs-on: ubuntu-22.04
    steps:
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake python3 git \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libvulkan-dev

      - name: Build Vulkan Headers (Fix Error 1.4.341)
        run: |
          # 1. Baixa os Headers oficiais mais recentes
          git clone https://github.com/KhronosGroup/Vulkan-Headers.git
          cd Vulkan-Headers
          
          # 2. Prepara a instalação local (para o CMake encontrar)
          mkdir build
          cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/tmp/vk_headers
          make install

      - name: Prepare VulkanTools & VkGHL
        run: |
          # Clona o VulkanTools (A "Casa")
          git clone https://github.com/LunarG/VulkanTools
          cd VulkanTools
          
          # Limpa pastas desnecessárias
          rm -rf layer_factory/assistant_layer
          rm -rf layer_factory/demo_layer
          rm -rf layer_factory/starter_layer
          
          # Clona o VkGHL (O "Hóspede")
          git clone https://github.com/pchome/VkGHL layer_factory/VkGHL

      - name: Build VkGHL for ARM64
        run: |
          cd VulkanTools
          mkdir build_arm64
          cd build_arm64
          
          # AQUI ESTÁ O TRUQUE: Adicionamos -DCMAKE_PREFIX_PATH apontando para os headers que compilamos acima
          cmake .. \
            -DCMAKE_PREFIX_PATH=/tmp/vk_headers \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=OFF \
            -DBUILD_LAYERSVT=OFF \
            -DBUILD_VKTRACE=OFF \
            -DBUILD_VIA=OFF \
            -DBUILD_LAYERMGR=OFF \
            -DBUILD_VKTRACE_REPLAY=OFF \
            -DVkLayer_VkGHL_INSTALL_DIR=/usr/lib
          
          make

      - name: Locate and Prepare Artifacts
        run: |
          mkdir -p output
          
          # Procura e copia a biblioteca gerada
          find VulkanTools/build_arm64 -name "libVkLayer_VkGHL.so" -exec cp {} output/ \;
          
          # Copia o JSON
          cp VulkanTools/layer_factory/VkGHL/VkLayer_VkGHL.json output/

      - uses: actions/upload-artifact@v4
        with:
          name: vkghl-arm64-fixed
          path: output/
